<!DOCTYPE html>
<html style="height: 100%">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>聊天消息-微尚</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.5 -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="adminlte/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect.
    -->
    <link rel="stylesheet" href="adminlte/css/skins/skin-blue.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body style="height: 100%;">
    <div class="row" style="height: 100%;">

      <div class="col-md-12" style="height: 100%;">
        <!-- DIRECT CHAT WARNING -->
        <div class="box box-primary box-solid direct-chat direct-chat-primary" style="height: 100%;">
          <div class="box-header">
            <span><i class="fa fa-chevron-left"></i>&nbsp&nbsp</span>
            <h3 class="box-title">聊天消息-微尚</h3>
          </div><!-- /.box-header -->
          <div class="box-body" style="height: 90%;">
            <!-- Conversations are loaded here -->
            <div class="direct-chat-messages" style="height: 100%">

              <!-- Message to the left or right -->

            </div><!--/.direct-chat-messages-->

          </div><!-- /.box-body -->
          <div class="box-footer" style="height: 10%;">
            <form class="input-group">
              <div class="input-group-addon"><i class="fa fa-smile-o"></i></div>
              <input type="text" placeholder="请输入您的的消息" class="form-control" id="inputMessage">
              <span class="input-group-btn">
                <button type="button" class="btn btn-primary btn-flat" id="sendButton">发送</button>
              </span>
            </form>
          </div><!-- /.box-footer-->
        </div><!--/.direct-chat -->
      </div>

    </div><!-- ./wrapper -->

    <!-- REQUIRED JS SCRIPTS -->

    <!-- jQuery 2.1.4 -->
    <script src="javascripts/jquery.min.js"></script>
    <!-- Bootstrap 3.3.5 -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- AdminLTE App -->
    <script src="adminlte/js/app.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>

    <script>
      $(document).ready(function(){
        var socket = io();

        var userid = Math.random()*900000|0+100000; //生成6位随机数
        var username = '用户' + userid;

        log('正在连接服务器...');
        socket.on('connect', function() {

            //用户登陆请求，传递用户名和id
            socket.emit('user login', {
              userid: userid,
              username: username,
            });

        });

        //收到服务器发来的log
        socket.on('log', function(msg) {
          log(msg);
        });

        socket.on('new message', function(data) {
          addStaffMessage({
            staffname: data.staffname,
            message: data.message
          });
        });


        //inputMessage检测回车发送消息
        $('#inputMessage').keydown(function(event) {
         if(13 == event.keyCode) {
            sendMessage();
            return false;
          }
        });
        $("#sendButton").click(function(){
          sendMessage();
        });

        function log(message) {
          $(".direct-chat-messages").append(
            '<p class="direct-chat-timestamp small" style="text-align: center;">' + message + '</p>'
          );
        }

        function sendMessage() {
          var message = $("#inputMessage").val();
          if (!message) { //如果内容为空
            return;
          }
          $("#inputMessage").val('');

          addUserMessage(message);

          socket.emit('user message', {
            userid: userid,
            username: username,
            message: message
          });
        }

        function addUserMessage(message) {
          $(".direct-chat-messages").append(
            '<div class="direct-chat-msg right"><div class="direct-chat-info clearfix"><span class="direct-chat-name pull-right">' + username +
            '</span><span class="direct-chat-timestamp pull-left">' + '</span><span class="direct-chat-timestamp pull-left">' + getCurTime() +
            '</span></div>' + '<img class="direct-chat-img" src="../images/user1-128x128.jpg" alt="message user image"><div class="direct-chat-text" style="float: right;margin-right: 10px;max-width: 90%;">' + message +
            '</div></div>'
          );
          chatMessagesToBottom();
        }

        function addStaffMessage(data) {
          $(".direct-chat-messages").append(
            '<div class="direct-chat-msg"><div class="direct-chat-info clearfix"><span class="direct-chat-name pull-left">' + data.staffname +
            '</span><span class="direct-chat-timestamp pull-left">' + '</span><span class="direct-chat-timestamp pull-right">' + getCurTime() +
            '</span></div>' + '<img class="direct-chat-img" src="../images/staff1-128x128.jpg" alt="message user image"><div class="direct-chat-text" style="float: left;margin-left: 10px;max-width: 90%;">' + data.message +
            '</div></div>'
          );
          chatMessagesToBottom();
        }
        //滚动聊天栏到最底部
        function chatMessagesToBottom() {
          var height = $(".direct-chat-messages").prop("scrollHeight");
          $(".direct-chat-messages").prop('scrollTop', height);
        }

        function getCurTime(){
          var t = new Date(),
            M = t.getMonth() + 1,
            D = t.getDate(),
            H = t.getHours(),
            m = t.getMinutes(),
            s = t.getSeconds();
          return [M, '-', D, ' ', H, ':', m, ':', s].join('');
        }




      });
    </script>

  </body>
</html>
